"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const taro_1=__importDefault(require("@tarojs/taro")),weapp_qrcode_1=__importDefault(require("weapp-qrcode"));class CanvasHelper{constructor(t){this.scale=1,this.ctx=null;var{ctx:t}=t;this.ctx=t,this.init()}async init(){var{screenWidth:t}=wx.getSystemInfoSync();this.scale=t/750}rpxToPx(t){return Math.round(t*this.scale)}loadImgs(e){return new Promise(async t=>{const i=[];e.map(async t=>{i.push(this.loadImage(t))}),t(await Promise.all(i))})}loadImage(e){return new Promise(async i=>{try{var t=await taro_1.default.getImageInfo({src:e});i({status:1,url:t.path,width:t.width,height:t.height})}catch(t){i({status:0,url:"",width:0,height:0})}})}async drawImage({url:t,x:s,y:r,width:x,height:o,radius:a=0,hMode:c="center",vMode:l="center"}){try{var p=await this.loadImage(t);if(1!==p.status)throw Error("读取图片资源失败");{this.ctx.save(),this.clipRaduisPath({x:s,y:r,width:x,height:o,radius:a});let t=p.width,i=p.height;var n=t/x,P=i/o;i=n<=P?(t=Math.round(t/n),Math.round(i/n)):(t=Math.round(t/P),Math.round(i/P));let e=0;switch(c){case"center":e=(p.width-x)/2;break;case"left":e=0;break;case"right":e=p.width-x}let h=0;switch(l){case"center":h=(p.height-o)/2;break;case"top":h=0;break;case"bottom":h=p.height-o}this.ctx.drawImage(p.url,e,h,p.width,p.height,this.rpxToPx(s),this.rpxToPx(r),this.rpxToPx(t),this.rpxToPx(i)),this.ctx.restore()}}catch(t){console.log(t)}}drawRect({bgColor:t,x:i,y:e,width:h,height:s,radius:r=0}){this.ctx.save(),this.clipRaduisPath({x:i,y:e,width:h,height:s,radius:r}),this.ctx.fillStyle=t,this.ctx.fill(),this.ctx.restore()}clipRaduisPath({x:t,y:i,width:e,height:h,radius:s=0}){const r={tl:0,tr:0,br:0,bl:0};Array.isArray(s)?(r.tl=s[0],r.tr=s[1],r.br=s[2],r.bl=s[3]):(r.tl=s,r.tr=s,r.br=s,r.bl=s),this.ctx.beginPath(),this.ctx.arc(this.rpxToPx(t+r.tl),this.rpxToPx(i+r.tl),this.rpxToPx(r.tl),Math.PI/180*180,Math.PI/180*270),this.ctx.lineTo(this.rpxToPx(t+r.tl),this.rpxToPx(i),this.rpxToPx(t+e-r.tr),this.rpxToPx(i)),this.ctx.arc(this.rpxToPx(t+e-r.tr),this.rpxToPx(i+r.tr),this.rpxToPx(r.tr),Math.PI/180*270,Math.PI/180*0),this.ctx.lineTo(this.rpxToPx(t+e),this.rpxToPx(i+r.tr),this.rpxToPx(t+e),this.rpxToPx(i+h-r.br)),this.ctx.arc(this.rpxToPx(t+e-r.br),this.rpxToPx(i+h-r.br),this.rpxToPx(r.br),Math.PI/180*0,Math.PI/180*90),this.ctx.lineTo(this.rpxToPx(t+e-r.br),this.rpxToPx(i+h),this.rpxToPx(t+r.bl),this.rpxToPx(i+h)),this.ctx.arc(this.rpxToPx(t+r.bl),this.rpxToPx(i+h-r.bl),this.rpxToPx(r.bl),Math.PI/180*90,Math.PI/180*180),this.ctx.lineTo(this.rpxToPx(t),this.rpxToPx(i+h-r.bl),this.rpxToPx(t),this.rpxToPx(i+r.tl)),this.ctx.clip()}initText({color:t,fontSize:i,fontWeight:e="normal",lineHeight:h=i,x:s,y:r,text:x,textAlign:o="left",textDecoration:a="none"}){this.ctx.save(),this.ctx.beginPath(),this.ctx.setFillStyle(t),this.ctx.font=`normal ${e} ${this.rpxToPx(i)}px sans-serif`,this.ctx.setTextBaseline("middle"),this.ctx.setTextAlign(o),this.ctx.fillText(x,this.rpxToPx(s),this.rpxToPx(r+h/2)),this.ctx.closePath(),this.ctx.restore(),"line-through"===a&&(this.ctx.save(),this.ctx.beginPath(),this.ctx.font=`normal ${e} ${this.rpxToPx(i)}px sans-serif`,{width:x}=this.ctx.measureText(x),this.ctx.setStrokeStyle(t),this.ctx.setLineWidth(1),this.ctx.moveTo(this.rpxToPx(s),this.rpxToPx(r+h/2)),this.ctx.lineTo(this.rpxToPx(s)+x,this.rpxToPx(r+h/2)),this.ctx.closePath(),this.ctx.stroke(),this.ctx.restore())}async drawQrcode({x:t,y:i,width:e,url:h}){await weapp_qrcode_1.default({x:this.rpxToPx(t),y:this.rpxToPx(i),reserve:!0,width:this.rpxToPx(e),height:this.rpxToPx(e),ctx:this.ctx,text:h,correctLevel:3})}breakText({str:i,maxByteLength:e,maxLine:h}){let s=0;const r=[];let x=[];for(let t=0;t<i.length;t++){var o=this.getCodeByte(i,t);if(r.length>=h){for(;e-s<3;){var a=this.getCodeByte(x[x.length-1]);s-=a,x.pop()}x.push("...")}else if(s+o>e){if(r.length+1>=h){for(;e-s<3;){var c=this.getCodeByte(x[x.length-1]);s-=c,x.pop()}x.push("...")}r.push(x.join("")),s=0,x=[],t--}else x.push(i[t]),s+=o,t===i.length-1&&r.push(x.join(""))}return r}getCodeByte(t,i=0){i=t.charCodeAt(i);let e=0;return e=1<=i&&i<=126||65376<=i&&i<=65439?1:2,e}draw(){this.ctx.draw(!0)}}exports.default=CanvasHelper;