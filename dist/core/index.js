"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const taro_1=__importDefault(require("@tarojs/taro")),weapp_qrcode_1=__importDefault(require("weapp-qrcode"));class CanvasHelper{constructor(t){this.scale=1,this.ctx=null;var{ctx:t}=t;this.ctx=t,this.init()}async init(){var{screenWidth:t}=wx.getSystemInfoSync();this.scale=t/750}rpxToPx(t){return Math.round(t*this.scale)}loadImgs(s){return new Promise(async t=>{const i=[];s.map(async t=>{i.push(this.loadImage(t))}),t(await Promise.all(i))})}loadImage(t){return new Promise(async i=>{try{i((await taro_1.default.getImageInfo({src:t})).path)}catch(t){i("")}})}drawImage({url:t,x:i,y:s,width:e,height:r,radius:x=0}){this.ctx.save(),this.clipRaduisPath({x:i,y:s,width:e,height:r,radius:x}),this.ctx.drawImage(t,this.rpxToPx(i),this.rpxToPx(s),this.rpxToPx(e),this.rpxToPx(r)),this.ctx.restore()}drawRect({bgColor:t,x:i,y:s,width:e,height:r,radius:x=0}){this.ctx.save(),this.clipRaduisPath({x:i,y:s,width:e,height:r,radius:x}),this.ctx.fillStyle=t,this.ctx.fill(),this.ctx.restore()}clipRaduisPath({x:t,y:i,width:s,height:e,radius:r=0}){const x={tl:0,tr:0,br:0,bl:0};Array.isArray(r)?(x.tl=r[0],x.tr=r[1],x.br=r[2],x.bl=r[3]):(x.tl=r,x.tr=r,x.br=r,x.bl=r),this.ctx.beginPath(),this.ctx.arc(this.rpxToPx(t+x.tl),this.rpxToPx(i+x.tl),this.rpxToPx(x.tl),Math.PI/180*180,Math.PI/180*270),this.ctx.lineTo(this.rpxToPx(t+x.tl),this.rpxToPx(i),this.rpxToPx(t+s-x.tr),this.rpxToPx(i)),this.ctx.arc(this.rpxToPx(t+s-x.tr),this.rpxToPx(i+x.tr),this.rpxToPx(x.tr),Math.PI/180*270,Math.PI/180*0),this.ctx.lineTo(this.rpxToPx(t+s),this.rpxToPx(i+x.tr),this.rpxToPx(t+s),this.rpxToPx(i+e-x.br)),this.ctx.arc(this.rpxToPx(t+s-x.br),this.rpxToPx(i+e-x.br),this.rpxToPx(x.br),Math.PI/180*0,Math.PI/180*90),this.ctx.lineTo(this.rpxToPx(t+s-x.br),this.rpxToPx(i+e),this.rpxToPx(t+x.bl),this.rpxToPx(i+e)),this.ctx.arc(this.rpxToPx(t+x.bl),this.rpxToPx(i+e-x.bl),this.rpxToPx(x.bl),Math.PI/180*90,Math.PI/180*180),this.ctx.lineTo(this.rpxToPx(t),this.rpxToPx(i+e-x.bl),this.rpxToPx(t),this.rpxToPx(i+x.tl)),this.ctx.clip()}initText({color:t,fontSize:i,fontWeight:s="normal",lineHeight:e=i,x:r,y:x,text:h,textAlign:o="left",textDecoration:a="none"}){this.ctx.save(),this.ctx.beginPath(),this.ctx.setFillStyle(t),this.ctx.font=`normal ${s} ${this.rpxToPx(i)}px sans-serif`,this.ctx.setTextBaseline("middle"),this.ctx.setTextAlign(o),this.ctx.fillText(h,this.rpxToPx(r),this.rpxToPx(x+e/2)),this.ctx.closePath(),this.ctx.restore(),"line-through"===a&&(this.ctx.save(),this.ctx.beginPath(),this.ctx.font=`normal ${s} ${this.rpxToPx(i)}px sans-serif`,{width:h}=this.ctx.measureText(h),this.ctx.setStrokeStyle(t),this.ctx.setLineWidth(1),this.ctx.moveTo(this.rpxToPx(r),this.rpxToPx(x+e/2)),this.ctx.lineTo(this.rpxToPx(r)+h,this.rpxToPx(x+e/2)),this.ctx.closePath(),this.ctx.stroke(),this.ctx.restore())}async drawQrcode({x:t,y:i,width:s,url:e}){await weapp_qrcode_1.default({x:this.rpxToPx(t),y:this.rpxToPx(i),reserve:!0,width:this.rpxToPx(s),height:this.rpxToPx(s),ctx:this.ctx,text:e,correctLevel:3})}breakText({str:i,maxByteLength:s,maxLine:e}){let r=0;const x=[];let h=[];for(let t=0;t<i.length;t++){var o=this.getCodeByte(i,t);if(x.length>=e){for(;s-r<3;){var a=this.getCodeByte(h[h.length-1]);r-=a,h.pop()}h.push("...")}else if(r+o>s){if(x.length+1>=e){for(;s-r<3;){var l=this.getCodeByte(h[h.length-1]);r-=l,h.pop()}h.push("...")}x.push(h.join("")),r=0,h=[],t--}else h.push(i[t]),r+=o,t===i.length-1&&x.push(h.join(""))}return x}getCodeByte(t,i=0){i=t.charCodeAt(i);let s=0;return s=1<=i&&i<=126||65376<=i&&i<=65439?1:2,s}draw(){this.ctx.draw(!0)}}exports.default=CanvasHelper;