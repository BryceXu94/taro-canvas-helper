"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const taro_1=__importDefault(require("@tarojs/taro")),weapp_qrcode_1=__importDefault(require("weapp-qrcode"));class CanvasHelper{constructor(t){this.scale=1,this.ctx=null;var{ctx:t}=t;this.ctx=t,this.init()}async init(){var{screenWidth:t}=wx.getSystemInfoSync();this.scale=t/750}rpxToPx(t){return Math.round(t*this.scale)}loadImgs(i){return new Promise(async t=>{const e=[];i.map(async t=>{e.push(this.loadImage(t))}),t(await Promise.all(e))})}loadImage(i){return new Promise(async e=>{try{var t=await taro_1.default.getImageInfo({src:i});e({status:1,url:t.path,width:t.width,height:t.height})}catch(t){console.log(t),e({status:0,url:"",width:0,height:0})}})}async drawImage({url:t,x:r,y:h,width:x,height:o,radius:a=0,hMode:c="center",vMode:l="center"}){try{var n=await this.loadImage(t);if(1!==n.status)throw Error("读取图片资源失败");{this.ctx.save(),this.clipRaduisPath({x:r,y:h,width:x,height:o,radius:a});let t=n.width,e=n.height;var p=t/x,P=e/o;e=p<=P?(t=Math.round(t/p),Math.round(e/p)):(t=Math.round(t/P),Math.round(e/P));let i=0;switch(c){case"center":i=(x-t)/2;break;case"left":i=0;break;case"right":i=x-t}let s=0;switch(l){case"center":s=(o-e)/2;break;case"top":s=0;break;case"bottom":s=o-e}this.ctx.drawImage(n.url,this.rpxToPx(r+i),this.rpxToPx(h+s),this.rpxToPx(t),this.rpxToPx(e)),this.ctx.restore()}}catch(t){console.log(t)}}drawRect({bgColor:t,x:e,y:i,width:s,height:r,radius:h=0}){this.ctx.save(),this.clipRaduisPath({x:e,y:i,width:s,height:r,radius:h}),this.ctx.fillStyle=t,this.ctx.fill(),this.ctx.restore()}clipRaduisPath({x:t,y:e,width:i,height:s,radius:r=0}){const h={tl:0,tr:0,br:0,bl:0};Array.isArray(r)?(h.tl=r[0],h.tr=r[1],h.br=r[2],h.bl=r[3]):(h.tl=r,h.tr=r,h.br=r,h.bl=r),this.ctx.beginPath(),this.ctx.arc(this.rpxToPx(t+h.tl),this.rpxToPx(e+h.tl),this.rpxToPx(h.tl),Math.PI/180*180,Math.PI/180*270),this.ctx.lineTo(this.rpxToPx(t+h.tl),this.rpxToPx(e),this.rpxToPx(t+i-h.tr),this.rpxToPx(e)),this.ctx.arc(this.rpxToPx(t+i-h.tr),this.rpxToPx(e+h.tr),this.rpxToPx(h.tr),Math.PI/180*270,Math.PI/180*0),this.ctx.lineTo(this.rpxToPx(t+i),this.rpxToPx(e+h.tr),this.rpxToPx(t+i),this.rpxToPx(e+s-h.br)),this.ctx.arc(this.rpxToPx(t+i-h.br),this.rpxToPx(e+s-h.br),this.rpxToPx(h.br),Math.PI/180*0,Math.PI/180*90),this.ctx.lineTo(this.rpxToPx(t+i-h.br),this.rpxToPx(e+s),this.rpxToPx(t+h.bl),this.rpxToPx(e+s)),this.ctx.arc(this.rpxToPx(t+h.bl),this.rpxToPx(e+s-h.bl),this.rpxToPx(h.bl),Math.PI/180*90,Math.PI/180*180),this.ctx.lineTo(this.rpxToPx(t),this.rpxToPx(e+s-h.bl),this.rpxToPx(t),this.rpxToPx(e+h.tl)),this.ctx.clip()}initText({color:t,fontSize:e,fontWeight:i="normal",lineHeight:s=e,x:r,y:h,text:x,textAlign:o="left",textDecoration:a="none"}){this.ctx.save(),this.ctx.beginPath(),this.ctx.setFillStyle(t),this.ctx.font=`normal ${i} ${this.rpxToPx(e)}px sans-serif`,this.ctx.setTextBaseline("middle"),this.ctx.setTextAlign(o),this.ctx.fillText(x,this.rpxToPx(r),this.rpxToPx(h+s/2)),this.ctx.closePath(),this.ctx.restore(),"line-through"===a&&(this.ctx.save(),this.ctx.beginPath(),this.ctx.font=`normal ${i} ${this.rpxToPx(e)}px sans-serif`,{width:x}=this.ctx.measureText(x),this.ctx.setStrokeStyle(t),this.ctx.setLineWidth(1),this.ctx.moveTo(this.rpxToPx(r),this.rpxToPx(h+s/2)),this.ctx.lineTo(this.rpxToPx(r)+x,this.rpxToPx(h+s/2)),this.ctx.closePath(),this.ctx.stroke(),this.ctx.restore())}async drawQrcode({x:t,y:e,width:i,url:s}){await weapp_qrcode_1.default({x:this.rpxToPx(t),y:this.rpxToPx(e),reserve:!0,width:this.rpxToPx(i),height:this.rpxToPx(i),ctx:this.ctx,text:s,correctLevel:3})}breakText({str:e,maxByteLength:i,maxLine:s}){let r=0;const h=[];let x=[];for(let t=0;t<e.length;t++){var o=this.getCodeByte(e,t);if(h.length>=s){for(;i-r<3;){var a=this.getCodeByte(x[x.length-1]);r-=a,x.pop()}x.push("...")}else if(r+o>i){if(h.length+1>=s){for(;i-r<3;){var c=this.getCodeByte(x[x.length-1]);r-=c,x.pop()}x.push("...")}h.push(x.join("")),r=0,x=[],t--}else x.push(e[t]),r+=o,t===e.length-1&&h.push(x.join(""))}return h}getCodeByte(t,e=0){e=t.charCodeAt(e);let i=0;return i=1<=e&&e<=126||65376<=e&&e<=65439?1:2,i}draw(){this.ctx.draw(!0)}}exports.default=CanvasHelper;